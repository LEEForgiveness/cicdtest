"use strict";
// Copyright 2018 The Casbin Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const casbin_1 = require("casbin");
// BasicAuthorizer class stores the casbin handler
class BasicAuthorizer {
    constructor(req, res, enforcer) {
        this.req = req;
        this.res = res;
        this.enforcer = enforcer;
    }
    // getUserName gets the user name from the request.
    // Currently, only HTTP basic authentication is supported
    getUserName() {
        if (this.res.locals.username != undefined)
            return this.res.locals.username;
        try {
            const header = this.req.get('Authorization');
            if (!header)
                return '';
            const arr = header.split(' ');
            if (arr[0].trim() != 'Basic')
                return '';
            const value = Buffer.from(arr[1], 'base64').toString('ascii');
            const tempArr = value.split(':');
            return tempArr[0];
        }
        catch (e) {
            console.log(e);
            return '';
        }
    }
    // checkPermission checks the user/method/path combination from the request.
    // Returns true (permission granted) or false (permission forbidden)
    checkPermission() {
        return __awaiter(this, void 0, void 0, function* () {
            const { req, enforcer } = this;
            const { originalUrl: path, method } = req;
            const user = this.getUserName();
            return enforcer.enforce(user, path, method);
        });
    }
}
// authz returns the authorizer, uses a Casbin enforcer as input
function authz(opt) {
    return (req, res, next) => __awaiter(this, void 0, void 0, function* () {
        const enforcer = yield opt.newEnforcer;
        if (!(enforcer instanceof casbin_1.Enforcer)) {
            res.status(500).json({ 500: 'Invalid enforcer' });
            return;
        }
        const authorizer = opt.authorizer ? opt.authorizer : new BasicAuthorizer(req, res, enforcer);
        const isAllowed = yield authorizer.checkPermission();
        if (!isAllowed) {
            res.status(403).json({ 403: 'Forbidden' });
            return;
        }
        next();
    });
}
exports.authz = authz;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aHouanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYXV0aHoudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDBEQUEwRDtBQUMxRCxFQUFFO0FBQ0Ysa0VBQWtFO0FBQ2xFLG1FQUFtRTtBQUNuRSwwQ0FBMEM7QUFDMUMsRUFBRTtBQUNGLGtEQUFrRDtBQUNsRCxFQUFFO0FBQ0Ysc0VBQXNFO0FBQ3RFLG9FQUFvRTtBQUNwRSwyRUFBMkU7QUFDM0Usc0VBQXNFO0FBQ3RFLGlDQUFpQzs7Ozs7Ozs7Ozs7QUFFakMsbUNBQWtDO0FBT2xDLGtEQUFrRDtBQUNsRCxNQUFNLGVBQWU7SUFLbkIsWUFBWSxHQUFZLEVBQUUsR0FBYSxFQUFFLFFBQWtCO1FBQ3pELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztJQUMzQixDQUFDO0lBRUQsbURBQW1EO0lBQ25ELHlEQUF5RDtJQUN6RCxXQUFXO1FBQ1QsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLElBQUksU0FBUztZQUFFLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO1FBRTNFLElBQUk7WUFDRixNQUFNLE1BQU0sR0FBVyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsTUFBTTtnQkFBRSxPQUFPLEVBQUUsQ0FBQztZQUN2QixNQUFNLEdBQUcsR0FBa0IsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM3QyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxPQUFPO2dCQUFFLE9BQU8sRUFBRSxDQUFDO1lBQ3hDLE1BQU0sS0FBSyxHQUFXLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN0RSxNQUFNLE9BQU8sR0FBa0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNoRCxPQUFPLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuQjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNmLE9BQU8sRUFBRSxDQUFDO1NBQ1g7SUFDSCxDQUFDO0lBRUQsNEVBQTRFO0lBQzVFLG9FQUFvRTtJQUM5RCxlQUFlOztZQUNuQixNQUFNLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxHQUFHLElBQUksQ0FBQztZQUMvQixNQUFNLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUM7WUFDMUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2hDLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLENBQUM7S0FBQTtDQUNGO0FBT0QsZ0VBQWdFO0FBQ2hFLFNBQWdCLEtBQUssQ0FBQyxHQUFpQjtJQUNyQyxPQUFPLENBQU8sR0FBWSxFQUFFLEdBQWEsRUFBRSxJQUFJLEVBQWlCLEVBQUU7UUFDaEUsTUFBTSxRQUFRLEdBQWEsTUFBTSxHQUFHLENBQUMsV0FBVyxDQUFDO1FBQ2pELElBQUksQ0FBQyxDQUFDLFFBQVEsWUFBWSxpQkFBUSxDQUFDLEVBQUU7WUFDbkMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO1lBQ2xELE9BQU87U0FDUjtRQUVELE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksZUFBZSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFN0YsTUFBTSxTQUFTLEdBQUcsTUFBTSxVQUFVLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDM0MsT0FBTztTQUNSO1FBQ0QsSUFBSSxFQUFFLENBQUM7SUFDVCxDQUFDLENBQUEsQ0FBQztBQUNKLENBQUM7QUFqQkQsc0JBaUJDIn0=